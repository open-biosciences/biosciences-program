# ADR-006: Single Writer Package Architecture for Parallel Development

**Status**: Accepted
**Version**: 1.0.0
**Date**: 2025-12-22
**Authors**: Don Branson
**Supersedes**: None
**Related**: ADR-001 (Architecture), ADR-005 (Git Worktrees)

---

## Context

### The Monolith Problem

After completing Phase 1 specifications for all 3 Tier 0 MCP servers (ChEMBL, Open Targets, DrugBank), we are ready for parallel implementation using git worktrees (ADR-005). However, the current codebase has a critical architectural flaw:

**`src/lifesciences_mcp/client.py`** is a 1,006-line monolithic file containing 6 client classes:

```python
# Current Structure: MONOLITH
client.py (1,006 lines)
├── LifeSciencesClient     # Lines 32-82   (base class, 50 lines)
├── HGNCClient             # Lines 84-341  (complete, 258 lines)
├── UniProtClient          # Lines 344-775 (complete, 432 lines)
├── ChEMBLClient           # Lines 778-858 (stub, 81 lines)
├── OpenTargetsClient      # Lines 860-942 (stub, 83 lines)
└── DrugBankClient         # Lines 945-1006 (stub, 62 lines)
```

### Why This Is Unacceptable

**Mathematical Certainty of Conflicts**: If 3 agents in 3 worktrees each modify `client.py`:

```
Worktree 1 (ChEMBL):      Adds ChEMBLClient.search_compounds()
Worktree 2 (Open Targets): Adds OpenTargetsClient.search_targets()
Worktree 3 (DrugBank):     Adds DrugBankClient.search_drugs()

All 3 agents write to the SAME FILE → 100% merge conflict rate
```

**Violation of ADR-005**: Git worktrees provide *filesystem isolation*, not *file-level isolation*. ADR-005 explicitly states:

> "Phase 0: Namespace Refactor (One-Time) - Before any parallel work, refactor shared resources to enforce 'Single Writer' safety"

Without this refactor, ADR-005's benefits are nullified.

---

## Decision

We mandate the **Single Writer Package Architecture**: split `client.py` into a `clients/` package where each implementation agent owns exactly one file.

### Target Structure

```
src/lifesciences_mcp/
├── clients/                      # NEW: Package replacing client.py
│   ├── __init__.py              # Re-exports all clients
│   ├── base.py                  # LifeSciencesClient (FROZEN)
│   ├── hgnc.py                  # HGNCClient (FROZEN, includes rate limiting)
│   ├── uniprot.py               # UniProtClient (FROZEN, includes rate limiting)
│   ├── chembl.py                # ChEMBLClient → Agent 1 OWNS
│   ├── opentargets.py           # OpenTargetsClient → Agent 2 OWNS
│   └── drugbank.py              # DrugBankClient → Agent 3 OWNS
├── models/                       # Unchanged
├── servers/                      # Unchanged
└── __init__.py                  # Updated to import from clients/
```

### Ownership Matrix

| File | Owner | Status During Parallel Implementation |
|------|-------|--------------------------------------|
| `clients/base.py` | None (shared) | **FROZEN** - Read-only |
| `clients/hgnc.py` | None (complete) | **FROZEN** - Read-only (includes rate limiting) |
| `clients/uniprot.py` | None (complete) | **FROZEN** - Read-only (includes rate limiting) |
| `clients/chembl.py` | **Agent 1** | Exclusive write access |
| `clients/opentargets.py` | **Agent 2** | Exclusive write access |
| `clients/drugbank.py` | **Agent 3** | Exclusive write access |
| `clients/__init__.py` | Sequential PR merge | Append-only exports |

**Rate Limiting Pattern**: Each client implements its own `_rate_limited_get()` method with exponential backoff and thundering herd prevention. This pattern is established in HGNCClient and UniProtClient and should be replicated in new clients.

### Compliance Requirements

#### BLOCKING GATE

**⚠️ The following commands are PROHIBITED until this ADR is fully implemented and merged to main:**

1. `/speckit.tasks` for any Tier 0 server
2. `/speckit.implement` for any Tier 0 server
3. `git worktree add` for implementation branches
4. Any parallel agent execution

**Violation Consequence**: Merge conflicts that require human intervention, potential data loss, wasted agent compute time.

#### VALIDATION CRITERIA

The refactor is complete when:

1. ✅ `clients/` directory exists with 7 files (6 modules + `__init__.py`)
2. ✅ `client.py` is deleted (no backward compatibility shim)
3. ✅ All 50 existing tests pass: `uv run pytest tests/ -v`
4. ✅ All imports updated to use `lifesciences_mcp.clients`
5. ✅ PR merged to main before any worktree creation

---

## Implementation

### Step 1: Create Package Structure

```bash
mkdir -p src/lifesciences_mcp/clients
touch src/lifesciences_mcp/clients/__init__.py
```

### Step 2: Extract Base Class

**File**: `clients/base.py`

```python
"""Base client for all Life Sciences API clients.

This module provides the shared LifeSciencesClient base class with:
- Async httpx client with connection pooling
- Session lifecycle management
- Common error handling patterns

Status: FROZEN - Do not modify during parallel implementation.
"""

import httpx
from typing import Any

class LifeSciencesClient:
    """Base async HTTP client for life sciences APIs."""

    def __init__(self, base_url: str, timeout: float = 30.0) -> None:
        self.base_url = base_url
        self.timeout = timeout
        self._client: httpx.AsyncClient | None = None

    async def _get_client(self) -> httpx.AsyncClient:
        if self._client is None:
            self._client = httpx.AsyncClient(
                base_url=self.base_url,
                timeout=self.timeout,
            )
        return self._client

    async def close(self) -> None:
        if self._client is not None:
            await self._client.aclose()
            self._client = None
```

### Step 3: Extract Each Client

Extract HGNCClient, UniProtClient, ChEMBLClient, OpenTargetsClient, DrugBankClient to their respective files, updating imports to use the new structure.

### Step 4: Create Package Exports

**File**: `clients/__init__.py`

```python
"""Life Sciences API Clients Package.

This package provides async HTTP clients for biological databases:
- LifeSciencesClient: Base class (shared)
- HGNCClient: Gene nomenclature (complete)
- UniProtClient: Protein data (complete)
- ChEMBLClient: Compound data (stub → Agent 1 implements)
- OpenTargetsClient: Target-disease (stub → Agent 2 implements)
- DrugBankClient: Drug data (stub → Agent 3 implements)

Usage:
    from lifesciences_mcp.clients import HGNCClient

    async with HGNCClient() as client:
        result = await client.search_genes("BRCA1")
"""

from lifesciences_mcp.clients.base import LifeSciencesClient
from lifesciences_mcp.clients.hgnc import HGNCClient
from lifesciences_mcp.clients.uniprot import UniProtClient
from lifesciences_mcp.clients.chembl import ChEMBLClient
from lifesciences_mcp.clients.opentargets import OpenTargetsClient
from lifesciences_mcp.clients.drugbank import DrugBankClient

__all__ = [
    "LifeSciencesClient",
    "HGNCClient",
    "UniProtClient",
    "ChEMBLClient",
    "OpenTargetsClient",
    "DrugBankClient",
]
```

### Step 5: Update Main Package

**File**: `src/lifesciences_mcp/__init__.py`

Update imports to use the new `clients` subpackage while maintaining backward compatibility.

### Step 6: Delete Monolith

Delete `client.py` entirely. No backward compatibility shim is maintained.

---

## Rationale

### Why Package Over Single File

| Criterion | Monolith (`client.py`) | Package (`clients/`) |
|-----------|------------------------|----------------------|
| **Parallel Safety** | ❌ 100% conflict rate | ✅ 0% conflict rate |
| **Code Organization** | ❌ 1,006 lines, hard to navigate | ✅ ~150-200 lines per file |
| **Ownership Clarity** | ❌ "Who owns this file?" | ✅ File name = owner |
| **Import Ergonomics** | ✅ Simple: `from client import X` | ✅ Same: `from clients import X` |
| **IDE Performance** | ⚠️ Large file, slow indexing | ✅ Fast per-file indexing |
| **Git Blame** | ❌ All 6 clients intermixed | ✅ Clean per-client history |

### Why Not Just Use Worktrees Without Refactoring

Git worktrees provide **directory-level** isolation, not **file-level** isolation:

```
# Without refactor:
.worktrees/chembl/src/lifesciences_mcp/client.py     # Agent 1 writes
.worktrees/opentargets/src/lifesciences_mcp/client.py # Agent 2 writes
.worktrees/drugbank/src/lifesciences_mcp/client.py    # Agent 3 writes

# All 3 modify the SAME logical file → merge conflicts guaranteed
```

```
# With refactor:
.worktrees/chembl/src/lifesciences_mcp/clients/chembl.py     # Agent 1 writes
.worktrees/opentargets/src/lifesciences_mcp/clients/opentargets.py # Agent 2 writes
.worktrees/drugbank/src/lifesciences_mcp/clients/drugbank.py  # Agent 3 writes

# Each agent owns a DIFFERENT file → merge conflicts impossible
```

---

## Consequences

### Positive

1. **Zero Merge Conflicts**: Mathematical guarantee during parallel implementation
2. **Clear Ownership**: File name indicates responsible agent
3. **Better Maintainability**: Smaller files, focused responsibility
4. **Faster Navigation**: IDE can index smaller files faster
5. **Clean Git History**: Per-client commit history without interleaving

### Negative

1. **One-Time Refactor Cost**: ~1.5 hours of work before implementation begins
2. **Import Path Change**: All imports must update to use `lifesciences_mcp.clients`
3. **More Files**: 7 files instead of 1 (complexity increase, but manageable)

### Neutral

1. **No Public API Change**: External consumers still use `from lifesciences_mcp import HGNCClient`
2. **Test Compatibility**: All tests continue to work without modification
3. **Documentation**: CLAUDE.md and README need minor updates

---

## Enforcement

### Pre-Implementation Gate Check

Before any `/speckit.tasks` or `/speckit.implement` command, verify:

```bash
# Check package structure exists
test -d src/lifesciences_mcp/clients && echo "✅ Package exists" || echo "❌ BLOCKED"

# Check all tests pass
uv run pytest tests/ -v --tb=short

# Check client.py is deleted
test ! -f src/lifesciences_mcp/client.py && echo "✅ client.py deleted" || echo "❌ client.py still exists"
```

### CI/CD Integration (Future)

Add to `.github/workflows/ci.yml`:

```yaml
- name: Verify Single Writer Architecture
  run: |
    if [ ! -d "src/lifesciences_mcp/clients" ]; then
      echo "ERROR: ADR-006 not implemented. Run Phase 0 refactor first."
      exit 1
    fi
```

---

## References

- **ADR-001 v1.2**: Agentic-First Architecture (establishes client patterns)
- **ADR-005 v1.0**: Git Worktrees (requires this refactor in Phase 0)
- **Git Worktrees Documentation**: https://git-scm.com/docs/git-worktree
- **Claude Code Parallel Sessions**: https://code.claude.com/docs/en/common-workflows#run-parallel-claude-code-sessions-with-git-worktrees

---

**Version History**:
- **v1.0.0** (2025-12-22): Initial ADR mandating Single Writer Package Architecture for parallel development
