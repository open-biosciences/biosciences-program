# ADR-005: Git Worktrees for Parallel MCP Server Development

**Status**: Accepted
**Version**: 1.1.0
**Date**: 2025-12-22 (Amended 2026-01-02)
**Authors**: Don Branson
**Supersedes**: None
**Related**: ADR-001 (Architecture), ADR-003 (SpecKit SDLC)

---

## Context

After successfully implementing HGNC and UniProt MCP servers sequentially, we identified an opportunity to accelerate development by implementing multiple servers in parallel. However, naive parallelization creates critical challenges:

### The "Merge Conflict" Problem

When multiple agents modify the same codebase simultaneously on a single machine:

**Scenario**: 3 agents implementing ChEMBL, Open Targets, and DrugBank servers in parallel.

**Without Worktrees**:
```python
# All 3 agents write to the same file
src/lifesciences_mcp/client.py
├── Agent 1: adds ChEMBLClient (lines 778-859)
├── Agent 2: adds OpenTargetsClient (lines 778-859)  # COLLISION!
└── Agent 3: adds DrugBankClient (lines 778-859)     # COLLISION!

# Result: Merge conflicts guaranteed
```

**Root Cause**: Shared filesystem state + concurrent writes = race conditions.

### Attempted Solutions and Their Failures

**Option 1: Single Repository, Time-Slicing**
- Run agents sequentially on same branch
- **Failed**: Loses parallelism benefits, takes 3× longer

**Option 2: Multiple Git Clones**
- Clone repository 3 times to separate directories
- **Failed**: Wastes disk space, complicates synchronization, separate git histories

**Option 3: Concurrent Branches in Same Working Directory**
- Use `git checkout` to switch branches rapidly
- **Failed**: Claude Code sessions interfere with each other's file state, leads to corrupted edits

**Option 4: Pre-allocate All Code Structures**
- Create empty client stubs for all 3 APIs before parallelization
- **Failed**: Violates "Just In Time" principle, requires upfront design of all 3 servers

### The Git Worktrees Solution

Git worktrees provide **filesystem isolation** with **shared git history**:

```bash
# Create 3 isolated working directories
.worktrees/
├── chembl/          # Branch: implement/003-chembl-mcp-server
│   └── src/lifesciences_mcp/client.py  # Agent 1 writes here
├── opentargets/     # Branch: implement/004-opentargets-mcp-server
│   └── src/lifesciences_mcp/client.py  # Agent 2 writes here
└── drugbank/        # Branch: implement/005-drugbank-mcp-server
    └── src/lifesciences_mcp/client.py  # Agent 3 writes here

# All share the same .git repository
# Zero merge conflicts during implementation
# Sequential PR merges after completion
```

**Key Insight**: Conflicts are deferred to PR merge time (controlled, sequential) instead of happening during implementation (chaotic, concurrent).

---

## Decision

We adopt **Git Worktrees as the canonical pattern for parallel MCP server development** on a single machine.

### Core Principles

1. **Filesystem Isolation**: Each agent operates in a dedicated worktree with its own working directory and branch
2. **Shared Git History**: All worktrees reference the same `.git` repository, eliminating duplication
3. **Sequential Integration**: Merge PRs one at a time after implementation, resolving conflicts in controlled manner
4. **Session Independence**: Each Claude Code session runs in its own terminal/worktree, preventing interference

### Workflow

**Phase 0: Namespace Refactor (One-Time)**

Before any parallel work, refactor shared resources to enforce "Single Writer" safety:

```bash
# Example: Split monolithic client.py into package
src/lifesciences_mcp/client.py  →  src/lifesciences_mcp/clients/
                                   ├── base.py       (shared, frozen)
                                   ├── hgnc.py       (existing)
                                   ├── uniprot.py    (existing)
                                   ├── chembl.py     (Agent 1 owns)
                                   ├── opentargets.py (Agent 2 owns)
                                   └── drugbank.py   (Agent 3 owns)
```

**Phase 1: Worktree Setup**

```bash
# Create worktree directory
mkdir -p .worktrees

# Create isolated branches and worktrees
git worktree add .worktrees/chembl -b implement/003-chembl-mcp-server
git worktree add .worktrees/opentargets -b implement/004-opentargets-mcp-server
git worktree add .worktrees/drugbank -b implement/005-drugbank-mcp-server

# Initialize environments in parallel
(cd .worktrees/chembl && uv sync) &
(cd .worktrees/opentargets && uv sync) &
(cd .worktrees/drugbank && uv sync) &
wait
```

**Phase 2: Parallel Implementation**

Launch 3 separate Claude Code sessions (terminals or tmux panes):

> ⚠️ **PROMPT SIZE LIMIT (v1.1.0 Amendment)**: The `-p` flag has a ~20KB prompt limit. If `tasks.md` exceeds ~20KB (typically >150 tasks), use **interactive mode** instead:
> ```bash
> cd .worktrees/chembl
> claude
> # Then type: /speckit.implement specs/003-chembl-mcp-server/tasks.md
> ```
> Check file size before using `-p`: `wc -c specs/*/tasks.md`

**For tasks.md under ~20KB** (use `-p` for automation):
```bash
# Terminal 1 (ChEMBL)
cd .worktrees/chembl
claude -p "/speckit.implement specs/003-chembl-mcp-server/tasks.md"

# Terminal 2 (Open Targets)
cd .worktrees/opentargets
claude -p "/speckit.implement specs/004-opentargets-mcp-server/tasks.md"

# Terminal 3 (DrugBank)
cd .worktrees/drugbank
claude -p "/speckit.implement specs/005-drugbank-mcp-server/tasks.md"
```

**For tasks.md over ~20KB** (use interactive mode):
```bash
# Terminal 1
cd .worktrees/ensembl
claude
# Type: /speckit.implement specs/008-ensembl-mcp-server/tasks.md

# Terminal 2
cd .worktrees/entrez
claude
# Type: /speckit.implement specs/009-entrez-mcp-server/tasks.md
```

**Phase 3: Sequential Integration**

```bash
# Agent 1 completes first
cd .worktrees/chembl
git push origin implement/003-chembl-mcp-server
# Create PR, review, merge to main

# Agent 2 completes second
cd .worktrees/opentargets
git fetch origin main  # Get Agent 1's changes
git rebase origin/main  # Resolve any conflicts
git push origin implement/004-opentargets-mcp-server
# Create PR, review, merge to main

# Agent 3 completes last
cd .worktrees/drugbank
git fetch origin main  # Get Agent 1 + 2 changes
git rebase origin/main
git push origin implement/005-drugbank-mcp-server
# Create PR, review, merge to main

# Cleanup
git worktree remove .worktrees/chembl
git worktree remove .worktrees/opentargets
git worktree remove .worktrees/drugbank
```

---

## Rationale

### Why Worktrees Over Alternatives

| Criterion | Git Worktrees | Multiple Clones | Sequential Work |
|-----------|---------------|-----------------|-----------------|
| **Filesystem Isolation** | ✅ Perfect | ✅ Perfect | ❌ None |
| **Disk Efficiency** | ✅ Shared .git | ❌ Duplicate .git | ✅ Single copy |
| **Parallelism** | ✅ 3× speedup | ✅ 3× speedup | ❌ Sequential |
| **Merge Complexity** | ✅ Deferred to PR | ⚠️ Manual sync | ✅ No conflicts |
| **Claude Code Compatibility** | ✅ Native support | ⚠️ Requires multi-instance setup | ✅ Works |

### Performance Implications

**Without Worktrees** (Sequential):
- Week 1: ChEMBL implementation (50 tests, ~5 days)
- Week 2: Open Targets implementation (50 tests, ~5 days)
- Week 3: DrugBank implementation (50 tests, ~5 days)
- **Total**: 15 days, 150 tests

**With Worktrees** (Parallel):
- Week 1: Specifications for all 3 APIs (sequential, required for design consistency)
- Week 2-3: All 3 implementations in parallel (~7-10 days, overlapping)
- **Total**: 10-14 days, 150 tests
- **Speedup**: 30-50% time reduction

### Risk Mitigation

**Risk 1: Thundering Herd on Local Machine**

**Problem**: 3 agents + 3 test suites running simultaneously might exhaust CPU/RAM.

**Mitigation**:
- Use `uv sync` to install dependencies once per worktree (shares central uv cache)
- Monitor resource usage: `htop` or Activity Monitor
- Fallback: Pause 1-2 agents if CPU spikes >90%, run sequentially

**Risk 2: API Rate Limits**

**Problem**: 3 agents hitting public APIs during testing might trigger IP bans.

**Mitigation**:
- ChEMBL and Open Targets have high rate limits (unlikely issue)
- DrugBank requires API key (throttled per key)
- Configure agents to use mock mode for heavy testing loops if needed

**Risk 3: Merge Conflicts During PR Integration**

**Problem**: Even with namespace refactor, shared files (e.g., `__init__.py`) might conflict.

**Mitigation**:
- **Phase 0 Refactor** eliminates 95% of potential conflicts
- Remaining conflicts (imports, exports) are trivial and resolvable in <5 minutes
- Sequential PR merges mean only 1 conflict resolution at a time

---

## Consequences

### Positive

1. **Faster Time-to-Market**: Implement 3 servers in time of 2 (30-50% reduction)
2. **Better Resource Utilization**: CPU cores idle during sequential work are now utilized
3. **Proven Pattern**: Git worktrees are a stable, well-documented Git feature (since Git 2.5, 2015)
4. **Claude Code Native Support**: Per [Claude Code docs](https://code.claude.com/docs/en/common-workflows#run-parallel-claude-code-sessions-with-git-worktrees), worktrees are explicitly recommended for parallel sessions
5. **Zero Data Loss**: All work preserved in Git, worktrees are disposable after merge

### Negative

1. **Initial Complexity**: Developers must learn worktree commands (`git worktree add/remove/list`)
2. **Disk Space**: 3 worktrees use ~3× the working directory size (mitigated by shared .git)
3. **Mental Model Shift**: Requires thinking in "parallel branches" instead of "single working directory"

### Neutral

1. **Not for All Projects**: Only beneficial when implementing 3+ similar features; overkill for 1-2 features
2. **Requires Planning**: Phase 0 namespace refactor must happen before parallelization
3. **Session Management**: Requires terminal multiplexer (tmux, screen) or multiple terminal windows

---

## Implementation Notes

### Prerequisites

- Git 2.5+ (worktrees introduced July 2015, stable since 2.7)
- Claude Code CLI installed
- Python project with `uv` package manager

### File Ownership After Phase 0 Refactor

Each agent owns a distinct set of files, preventing conflicts:

| Agent | Owned Files | Shared (Read-Only During Parallel Work) |
|-------|-------------|------------------------------------------|
| ChEMBL | `clients/chembl.py`, `servers/chembl.py`, `models/compound.py`, `tests/*/test_chembl*.py` | `clients/base.py`, `__init__.py` |
| Open Targets | `clients/opentargets.py`, `servers/opentargets.py`, `models/target.py`, `tests/*/test_opentargets*.py` | `clients/base.py`, `__init__.py` |
| DrugBank | `clients/drugbank.py`, `servers/drugbank.py`, `models/drug.py`, `tests/*/test_drugbank*.py` | `clients/base.py`, `__init__.py` |

### Monitoring Parallel Agents

```bash
# List all active worktrees
git worktree list

# Check agent progress
cd .worktrees/chembl && git log --oneline -5
cd .worktrees/opentargets && git log --oneline -5
cd .worktrees/drugbank && git log --oneline -5

# Monitor resource usage
htop  # Linux
top   # macOS
```

---

## References

- **Git Worktrees Documentation**: https://git-scm.com/docs/git-worktree
- **Claude Code Worktrees Workflow**: [Claude Code Common Workflows - Run parallel Claude Code sessions with Git worktrees](https://code.claude.com/docs/en/common-workflows#run-parallel-claude-code-sessions-with-git-worktrees)
- **ADR-001 v1.2**: Agentic-First Architecture (establishes patterns to be parallelized)
- **ADR-003 v1.0**: SpecKit SDLC (defines `/speckit.specify` → `/speckit.plan` → `/speckit.implement` workflow)
- **Platform Engineering Rationale**: `docs/platform-engineering-rationale.md` (explains why we codify patterns)

---

## Appendix A: Example Session Output

```bash
$ mkdir -p .worktrees
$ git worktree add .worktrees/chembl -b implement/003-chembl-mcp-server
Preparing worktree (new branch 'implement/003-chembl-mcp-server')
HEAD is now at a4dfd0d docs: update CLAUDE.md and README.md with US3+US4 completion

$ git worktree list
/home/user/lifesciences-research                    a4dfd0d [main]
/home/user/lifesciences-research/.worktrees/chembl  a4dfd0d [implement/003-chembl-mcp-server]

$ cd .worktrees/chembl
$ uv sync
Resolved 42 packages in 1.2s
Installed 42 packages in 850ms

$ claude -p "/speckit.implement specs/003-chembl-mcp-server/tasks.md"
[Agent begins implementation...]
```

---

**Version History**:
- **v1.1.0** (2026-01-02): Added prompt size limit warning (~20KB) for `-p` flag; documented interactive mode fallback for large tasks.md files
- **v1.0.0** (2025-12-22): Initial ADR documenting git worktrees pattern for parallel MCP server development
