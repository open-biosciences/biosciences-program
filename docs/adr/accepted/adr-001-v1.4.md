# ADR-001 v1.4: The "Agentic-First" Architecture for Life Sciences Integration

**Status:** APPROVED (Stable Reference)
**Date:** 2026-01-10
**Version:** 1.4 (Stable Architectural Reference)
**Context:** The `@lifesciences-research` project aims to create a Model Context Protocol (MCP) server that enables LLM agents to reason across heterogeneous biological datasets.

**Changelog:**
- v1.0: Synthesized Technical Standards & Agentic Strategy.
- v1.1: Added Normative Envelopes (Pagination/Error), Key Registries, and Token Budgeting controls.
- v1.2: Extended Cross-Reference Key Registry to cover all Discovery APIs (Tiers 0-4). Added null handling policy and cardinality rules.
- v1.3: Refactored `CrossReferences` into independent Shared Protocol Type (Decoupled from Gene model). Added `ucsc` and `pubmed` to Core Identifiers.
- v1.4: Removed Implementation Checklist (Appendix C). ADRs document architectural decisions, not implementation progress.

---

## 1. Context and Problem Statement

Traditional bioinformatics middleware relies on synchronous scripts that fail under agentic concurrency. Furthermore, inconsistent schema definitions across tools (e.g., `next_token` vs. `cursor`) prevent agents from reliably traversing datasets.

We must define a unified, high-performance architecture with **strict schema determinism** to enable reliable autonomous reasoning.

## 2. Decision: The Hybrid Client Architecture

To resolve the tension between modern performance and legacy domain logic:

* **Strict Async (Greenfield):** For modern APIs (Open Targets, HGNC, UniProt), we **reject** official synchronous SDKs. Implement custom `httpx` clients with connection pooling.
* **Executor Pattern (Brownfield):** For ChEMBL, retain the official `chembl_webresource_client` encapsulated in a `run_in_executor` thread pool.
* **Constraint:** Legacy wrappers **MUST** expose batch tools (e.g., `chembl_get_drugs_batch`) to prevent thread pool exhaustion.

## 3. Decision: The "Fuzzy-to-Fact" Resolution Protocol

To prevent hallucinated mappings, we enforce a bi-modal workflow:

* **Phase 1: Fuzzy Discovery:** Tools accept natural language and return **Ranked Candidates** or **Functional Groups** (for pathway queries).
* **Phase 2: Strict Execution:** Tools accept **only** resolved CURIEs (e.g., `HGNC:1101`).
* **Failure Mode:** Passing a raw string to a Strict Tool **MUST** return a structured `UNRESOLVED_ENTITY` error (see Section 8).

## 4. Decision: The "Agentic Biolink" Schema

We adopt a **Pruned Biolink** schema enriched with **Cognitive Hooks** to aid triangulation.

* **Vocabulary:** Keys must use Biolink Model terms (e.g., `biolink:treats`).
* **Structure:** Flattened JSON (no deep TRAPI nesting).
* **Mandate:** Every entity response **MUST** include a `cross_references` object adhering to the **Key Registry** (Appendix A).

## 5. Decision: Tool/Resource Bifurcation

* **Tools (Reasoning):** Return JSON. Capped at 50 items. **MUST** use the **Canonical Pagination Envelope** (Section 8).
* **Resources (Reading):** Return raw text/binary via custom URI schemes (`uniprot://sequence/{id}`, `pdb://structure/{id}`).

## 6. Decision: Triangulation

Agents **MUST** verify high-stakes assertions by checking the `cross_references` object across sources (e.g., verifying a ChEMBL target ID appears in a UniProt entry).

## 7. Decision: Traffic Control (Token Budgeting)

To prevent context flooding during multi-hop reasoning:

* **Slim Mode:** All Batch Tools **MUST** accept a `slim=True` parameter.
  * *Default (False):* Returns full Agentic Biolink record (~115-300 tokens/entity depending on cross-references).
  * *Slim (True):* Returns only `id`, `name`, and `score` (~20 tokens/entity).

* **Page Size:** Default page size is 50. Agents should be instructed via System Prompt to use `slim=True` for broad discovery steps.

* **Cross-Reference Budget:** Well-connected entities (e.g., TP53) may have extensive cross-references. Slim mode is **mandatory** for list operations.

---

## 8. Normative Schemas (The "Envelopes")

All tools **MUST** wrap their output in these exact structures.

### A. Canonical Pagination Envelope

*Prevents fragmentation where tools use different keys for cursors.*

```json
{
  "items": [ ... ],             // The data payload (List[AgenticBiolink])
  "pagination": {
    "cursor": "opaque_string",  // Pass this to 'cursor' arg of next call. null = end.
    "total_count": 1540,        // Integer or null if unknown.
    "page_size": 50
  }
}
```

### B. Canonical Error Envelope

*Allows the agent to self-heal instead of crashing.*

```json
{
  "success": false,
  "error": {
    "code": "UNRESOLVED_ENTITY",  // See Appendix B for Registry
    "message": "The input 'BRCA1' is not a resolved CURIE.",
    "recovery_hint": "Call 'resolve_gene' to get a valid ID first.",
    "invalid_input": "BRCA1"
  }
}
```

## 9. Decision: Shared Types vs. Domain Types (v1.3)

To prevent "God Objects" and cyclic dependencies, we enforce a strict separation between **Protocol Types** (shared schemas) and **Domain Types** (entity models).

*   **Protocol Type:** `CrossReferences` (in `models/cross_references.py`). Represents the *linking structure* between any two biological entities. Must be importable by ANY model without importing a specific domain model (like `Gene`).
*   **Domain Type:** `Gene`, `Protein`, `Target`. Represents a specific biological entity. Can import Protocol Types, but Protocol Types MUST NOT import Domain Types.

---

## Appendix A: Cross-Reference Key Registry (Extended)

*Developers MUST use these exact keys and types. Keys are grouped by Discovery Tier.*

### Null Handling Policy

- If a cross-reference doesn't exist for an entity, **omit the key entirely**
- Do NOT set to `null` or empty string
- This minimizes token usage for entities with sparse cross-references

### Cardinality Rules

- **String:** 1:1 mapping (most common)
- **List[String]:** Use for isoforms, transcript variants, multiple structures, pathway memberships

---

### Core Identifiers

| Key Name | ID Type | Format Regex | Cardinality | Notes |
|----------|---------|--------------|-------------|-------|
| `hgnc` | HGNC ID | `^HGNC:\d+$` | String | Gene nomenclature authority |
| `ensembl_gene` | Ensembl Gene | `^ENSG\d{11}$` | String | Primary Gene ID |
| `ensembl_transcript` | Ensembl Transcript | `^ENST\d{11}$` | List[String] | Transcript variants |
| `uniprot` | UniProt Accession | `^[A-Z0-9]{6,10}$` | List[String] | Handles isoforms |
| `entrez` | NCBI Gene ID | `^\d+$` | String | NCBI Entrez |
| `refseq` | RefSeq Accession | `^[NX][MR]_\d+$` | List[String] | NCBI sequences |
| `ucsc` | UCSC Genome Browser | `^UCSC:[\w]+\.[\d]+$` | String | Transcript ID |
| `pubmed` | PubMed ID | `^PMID:\d+$` | List[String] | Literature references |

### Tier 0: Drug Discovery Core

| Key Name | ID Type | Format Regex | Cardinality | Notes |
|----------|---------|--------------|-------------|-------|
| `chembl` | ChEMBL ID | `^CHEMBL\d+$` | String | Targets, drugs, assays |
| `drugbank` | DrugBank ID | `^DB\d{5}$` | String | Drug information |

### Tier 1-2: Interaction Networks

| Key Name | ID Type | Format Regex | Cardinality | Notes |
|----------|---------|--------------|-------------|-------|
| `string` | STRING ID | `^\d+\.[A-Za-z0-9]+$` | String | Protein-protein interactions |
| `biogrid` | BioGRID ID | `^\d+$` | String | Genetic interactions |
| `stitch` | STITCH ID | `^(CID[sm])?\d+$` | String | Chemical-protein interactions |
| `iuphar` | GtoPdb Target ID | `^\d+$` | String | Pharmacological targets |

### Tier 3: Pathways & Disease

| Key Name | ID Type | Format Regex | Cardinality | Notes |
|----------|---------|--------------|-------------|-------|
| `kegg` | KEGG Gene ID | `^[a-z]{3,4}:\d+$` | String | e.g., `hsa:672` |
| `kegg_pathway` | KEGG Pathway ID | `^[a-z]{3,4}\d{5}$` | List[String] | e.g., `hsa05224` |
| `omim` | OMIM ID | `^\d{6}$` | String | Genetic disorders |
| `orphanet` | Orphanet ID | `^ORPHA:\d+$` | String | Rare diseases |
| `mondo` | MONDO ID | `^MONDO:\d{7}$` | String | Disease ontology |
| `efo` | EFO ID | `^EFO:\d{7}$` | String | Experimental Factor Ontology |

### Tier 4: Structural & Chemical

| Key Name | ID Type | Format Regex | Cardinality | Notes |
|----------|---------|--------------|-------------|-------|
| `pdb` | PDB Structure ID | `^[0-9][A-Z0-9]{3}$` | List[String] | Protein structures |
| `pubchem_compound` | PubChem CID | `^\d+$` | String | Chemical compounds |
| `pubchem_substance` | PubChem SID | `^\d+$` | String | Substance records |

---

## Appendix B: Error Code Registry

*Standardized codes for programmatic error handling.*

| Code | Meaning | Agent Action |
|------|---------|--------------|
| `UNRESOLVED_ENTITY` | Raw string passed to strict tool. | Call `resolve_*` tool. |
| `ENTITY_NOT_FOUND` | Valid CURIE format, but ID not in DB. | Check inputs or try synonym. |
| `AMBIGUOUS_QUERY` | Fuzzy search returned >100 hits. | Refine query terms. |
| `RATE_LIMITED` | Upstream API 429. | Retry with backoff. |
| `UPSTREAM_ERROR` | API 500/502. | Report outage to user. |
| `INVALID_CROSS_REFERENCE` | Cross-reference ID failed regex validation. | Report data quality issue. |

---

## Approval Chain

| Role | Name | Date | Status |
|------|------|------|--------|
| Lead Architect | Claude Code | 2025-12-21 | Approved |
| Enterprise Architect | Don Branson | 2025-12-21 | Approved |
| Maintenance | Antigravity | 2026-01-10 | Amended v1.4 |

---

## Document History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-21 | Claude Code | Initial synthesis |
| 1.1 | 2025-12-21 | Claude Code | Added envelopes, registries, token budgeting |
| 1.2 | 2025-12-21 | Claude Code | Extended key registry (16 keys), null handling, cardinality rules |
| 1.3 | 2026-01-09 | Antigravity | Added `ucsc` and `pubmed` to Core Identifiers |
| 1.4 | 2026-01-10 | Claude Code | Removed Implementation Checklist (Appendix C) |

---

**END OF SPECIFICATION**
