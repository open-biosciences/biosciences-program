# Implementation Plan: ClinicalTrials.gov MCP Server

**Branch**: `013-clinicaltrials-mcp-server` | **Date**: 2026-01-03 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/013-clinicaltrials-mcp-server/spec.md`

**Note**: This template is filled in by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Implement a FastMCP server for ClinicalTrials.gov API v2 following the Fuzzy-to-Fact protocol. The server provides three tools: `search_trials` (fuzzy discovery using natural language queries with filters), `get_trial` (strict lookup by NCT CURIE), and `get_trial_locations` (facility/contact data). All responses use Canonical Envelopes (PaginationEnvelope, ErrorEnvelope) with Agentic Biolink schema. Conservative 1 req/sec rate limiting prevents API throttling. Deep JSON nesting (5 sections per trial) requires field selection for token optimization. Limited cross-references (PubMed, registry IDs) compared to gene/protein APIs.

## Technical Context

**Language/Version**: Python 3.11+
**Primary Dependencies**: FastMCP >=2.0, httpx >=0.27, pydantic >=2.0
**Storage**: N/A (stateless, live queries to ClinicalTrials.gov API v2)
**Testing**: pytest >=7.0, pytest-asyncio >=0.21
**Target Platform**: Linux/macOS server (MCP protocol via stdio/sse/http)
**Project Type**: single (MCP server with client library)
**Performance Goals**: <2s for 95% of search queries, <3s for Fuzzy-to-Fact workflow (SC-001, SC-002)
**Constraints**: 1 req/sec rate limit (conservative, API allows ~50 req/min), 5K-10K tokens per full trial response
**Scale/Scope**: 450K+ trials in ClinicalTrials.gov database, pagination required for broad queries

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Principle I: Async-First Architecture ✅ PASS

**Evaluation**: ClinicalTrials.gov API v2 is a modern REST API supporting async I/O.

**Implementation**:
- ✅ Native httpx async client extending LifeSciencesClient base class
- ✅ No synchronous SDKs identified (unlike ChEMBL)
- ✅ All endpoints return JSON (no blocking XML parsers needed)

**Decision**: Full async compliance with ADR-001 §2 pattern.

---

### Principle II: Fuzzy-to-Fact Resolution Protocol ✅ PASS

**Evaluation**: Feature spec explicitly requires Fuzzy-to-Fact workflow.

**Implementation**:
- ✅ Phase 1 (Fuzzy): `search_trials` accepts natural language queries
- ✅ Phase 2 (Strict): `get_trial` accepts ONLY NCT CURIEs (NCT:########)
- ✅ Error mode: UNRESOLVED_ENTITY with recovery_hint to search_trials

**Decision**: Compliant with Constitution Principle II.

---

### Principle III: Schema Determinism ✅ PASS

**Evaluation**: Feature spec requires Canonical Envelopes and Agentic Biolink schema.

**Implementation**:
- ✅ PaginationEnvelope for search_trials (FR-015)
- ✅ ErrorEnvelope for all errors (FR-016)
- ✅ Standardized error codes: UNRESOLVED_ENTITY, ENTITY_NOT_FOUND, RATE_LIMITED, UPSTREAM_ERROR, INVALID_INPUT
- ✅ Cross-references object (limited: pubmed, clinicaltrials_gov, mesh_conditions, mesh_interventions)
- ✅ Omit-if-null pattern (FR-014)

**Decision**: Full compliance with ADR-001 §8 Canonical Envelopes.

---

### Principle IV: Token Budgeting ⚠️ ADVISORY

**Evaluation**: ClinicalTrials.gov trials have deep JSON nesting (5 sections: protocolSection, resultsSection, derivedSection, annotationSection, documentSection). Full trial responses can be 5K-10K tokens.

**Implementation**:
- ✅ Use API `fields` parameter to request minimal fields for search results
- ✅ TrialSearchCandidate schema includes only: nct_id, title, brief_summary, phase, status, conditions, interventions (~100-200 tokens)
- ⚠️ Trial schema (strict lookup) includes full details (~5K-10K tokens)
- ❌ No `slim=True` parameter planned for `get_trial` (not a batch operation)

**Advisory Notes**:
- API does not support batch lookups (no equivalent to ChEMBL's `filter()`)
- Each trial lookup is a discrete HTTP request (1 req/sec rate limit)
- Agents should use `get_trial` selectively after fuzzy search
- Future enhancement: Add `fields` parameter to `get_trial` for user-controlled token budgeting

**Decision**: PASS with advisory note. Token budgeting applies primarily to search results (fuzzy phase), not individual strict lookups.

---

### Principle V: Specification-Before-Code ✅ PASS

**Evaluation**: This plan is being generated by `/speckit.plan` command.

**Implementation**:
- ✅ Feature spec created via `/speckit.specify`
- ✅ Implementation plan being created via `/speckit.plan`
- ✅ Tasks will be generated via `/speckit.tasks`
- ✅ Human approval gate before `/speckit.implement`

**Decision**: Compliant with SpecKit workflow.

---

### Principle VI: Platform Skill Delegation ✅ PASS

**Evaluation**: New MCP server creation requires scaffolding.

**Implementation**:
- ✅ `/scaffold-fastmcp` skill will be used to generate:
  - `src/lifesciences_mcp/servers/clinicaltrials.py`
  - `src/lifesciences_mcp/clients/clinicaltrials.py`
  - `src/lifesciences_mcp/models/trial.py`
  - Integration test stubs
- ✅ No manual file creation bypassing Platform Skills

**Decision**: Compliant with Constitution Principle VI.

---

### Forbidden Patterns Check ✅ PASS

| Pattern | Status | Notes |
|---------|--------|-------|
| Synchronous blocking in async | ✅ PASS | httpx async client only |
| Hardcoded credentials | ✅ PASS | No authentication required |
| Raw strings to strict tools | ✅ PASS | UNRESOLVED_ENTITY enforcement |
| Null cross-references | ✅ PASS | Omit-if-null pattern |
| Skip specification | ✅ PASS | Using SpecKit workflow |
| Bypass Platform Skills | ✅ PASS | Will use scaffold-fastmcp |
| Deep JSON nesting | ⚠️ ADVISORY | API returns nested JSON; flattened in Agentic Biolink schema |
| Unbounded Concurrency | ✅ PASS | 1 req/sec rate limiting with exponential backoff |

---

### Required Patterns Check ✅ PASS

| Pattern | Status | Implementation |
|---------|--------|----------------|
| Canonical Pagination Envelope | ✅ PASS | PaginationEnvelope with cursor, total_count, page_size |
| Canonical Error Envelope | ✅ PASS | ErrorEnvelope with code, message, recovery_hint, invalid_input |
| Cross-reference regex validation | ✅ PASS | NCT ID: `^NCT\d{8}$`, PubMed: `^\d+$` |
| Pre-flight checks | ✅ PASS | N/A (not a deployment) |
| Human approval gate | ✅ PASS | Plan → approval → /speckit.implement |
| Async httpx clients | ✅ PASS | Native httpx extending LifeSciencesClient |
| slim=True support | ⚠️ ADVISORY | Search results use minimal fields; strict lookup returns full data (not a batch operation) |
| Client-side Rate Limiting | ✅ PASS | 1 req/sec with exponential backoff, thundering herd prevention |

---

### Constitution Compliance Summary

**Status**: ✅ **PASS** (with 2 advisory notes)

**Violations**: None

**Advisory Notes**:
1. **Token Budgeting**: Full trial responses (~5K-10K tokens) are acceptable for strict lookups (not batch operations). Search results use minimal fields for token efficiency.
2. **Deep JSON Nesting**: ClinicalTrials.gov API returns deeply nested JSON; we flatten it in the Agentic Biolink schema layer.

**Recommendation**: Proceed to Phase 0 (Research). Re-evaluate after Phase 1 design.

---

## Post-Design Constitution Re-evaluation

**Date**: 2026-01-03 (after Phase 1 completion)

### Design Artifacts Generated

1. ✅ **research.md** - Comprehensive API exploration (1,495 lines, 16 sections)
2. ✅ **data-model.md** - Pydantic schemas with Agentic Biolink compliance
3. ✅ **contracts/search_trials.md** - Fuzzy search tool contract
4. ✅ **contracts/get_trial.md** - Strict lookup tool contract
5. ✅ **contracts/get_trial_locations.md** - Location lookup tool contract
6. ✅ **quickstart.md** - 5 workflows + error recovery + integration patterns

### Constitution Re-Check

#### Principle I: Async-First Architecture ✅ CONFIRMED
- Data model confirms httpx-based async client extending LifeSciencesClient
- No synchronous blocking calls in design
- All I/O operations use async/await

#### Principle II: Fuzzy-to-Fact Resolution Protocol ✅ CONFIRMED
- `search_trials` returns TrialSearchCandidate with NCT CURIEs
- `get_trial` enforces NCT CURIE validation (`^NCT:\d{8}$`)
- UNRESOLVED_ENTITY error with recovery hints for query strings passed to strict tools
- Quickstart demonstrates complete Fuzzy-to-Fact workflow

#### Principle III: Schema Determinism ✅ CONFIRMED
- PaginationEnvelope used for `search_trials` with cursor, total_count, page_size
- ErrorEnvelope used for all errors with code, message, recovery_hint, invalid_input
- Cross-references object defined (pubmed, clinicaltrials_gov, mesh_conditions, mesh_interventions)
- Omit-if-null pattern enforced in all data models
- Error codes: UNRESOLVED_ENTITY, ENTITY_NOT_FOUND, INVALID_INPUT, RATE_LIMITED, UPSTREAM_ERROR

#### Principle IV: Token Budgeting ✅ CONFIRMED (with advisory note)
- TrialSearchCandidate: ~100-200 tokens (uses API `fields` parameter for minimal data)
- Trial: ~5K-10K tokens (full details, acceptable for strict lookups)
- No `slim=True` parameter (not a batch operation; API doesn't support batch)
- Token optimization via search-then-lookup pattern (documented in quickstart)

**Advisory Note**: Token budgeting challenge acknowledged and mitigated through:
1. Minimal field selection for search results
2. Clear guidance to use `get_trial` selectively after fuzzy search
3. No batch operations (API limitation prevents token accumulation issues)

#### Principle V: Specification-Before-Code ✅ CONFIRMED
- Feature spec created via `/speckit.specify`
- Implementation plan created via `/speckit.plan`
- All design artifacts complete (research, data model, contracts, quickstart)
- Next step: `/speckit.tasks` for bounded task generation
- Human approval gate enforced before `/speckit.implement`

#### Principle VI: Platform Skill Delegation ✅ CONFIRMED
- Design specifies use of `/scaffold-fastmcp` skill for code generation
- Project structure documented for scaffolding:
  - `src/lifesciences_mcp/models/trial.py`
  - `src/lifesciences_mcp/clients/clinicaltrials.py`
  - `src/lifesciences_mcp/servers/clinicaltrials.py`
  - Test stubs in `tests/unit/`, `tests/integration/`, `tests/contract/`

### Final Compliance Status

**Overall**: ✅ **PASS** (no violations, 1 advisory note)

**Advisory Notes After Design**:
1. **Token Budgeting**: Design confirms token optimization strategy via minimal search fields and selective strict lookups. No batch operations (API limitation), so no accumulation risk.

**Recommendation**: ✅ **APPROVE for Phase 2 (Tasks Generation)**

All Constitution principles satisfied. Design artifacts complete and compliant. Ready for `/speckit.tasks` to generate bounded implementation tasks.

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
src/lifesciences_mcp/
├── models/
│   ├── trial.py                    # Trial, TrialSearchCandidate (NEW)
│   ├── trial_location.py           # TrialLocation (NEW)
│   └── envelopes.py                # PaginationEnvelope, ErrorEnvelope (EXISTING)
├── clients/
│   ├── base.py                     # LifeSciencesClient (EXISTING)
│   └── clinicaltrials.py           # ClinicalTrialsClient (NEW)
└── servers/
    └── clinicaltrials.py           # FastMCP server with 3 tools (NEW)

tests/
├── unit/
│   ├── test_trial_models.py        # Pydantic model validation (NEW)
│   ├── test_trial_location_models.py # Location model validation (NEW)
│   ├── test_clinicaltrials_client.py # Client unit tests (NEW)
│   └── test_error_envelopes.py     # Error envelope validation (NEW)
├── integration/
│   ├── test_clinicaltrials_api.py  # End-to-end API tests (NEW)
│   ├── test_fuzzy_to_fact.py       # Workflow tests (NEW)
│   └── test_error_recovery.py      # Error recovery tests (NEW)
└── contract/
    └── test_canonical_envelopes.py # Schema compliance tests (NEW)
```

**Structure Decision**: Single project structure (Option 1). All code lives in `src/lifesciences_mcp/` with standard three-layer architecture: models (Pydantic schemas), clients (API wrappers), servers (FastMCP tools). Tests organized by type: unit (no external I/O), integration (live API calls), contract (schema validation).

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

**No violations identified.** All Constitution principles pass with 2 advisory notes (token budgeting for full trial responses, deep JSON nesting from upstream API). See Constitution Check section above for details.
