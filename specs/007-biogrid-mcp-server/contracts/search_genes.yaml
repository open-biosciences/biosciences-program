# Tool Contract: search_genes

tool_name: search_genes
phase: fuzzy
protocol: API-Backed Gene Search (Fuzzy-to-Fact Phase 1)

description: |
  Search for a gene in BioGRID and confirm it exists in the database.
  Queries the BioGRID /interactions endpoint with format=count for lightweight
  existence verification (~200ms). Returns interaction_count metadata.
  Nonexistent genes receive ENTITY_NOT_FOUND error.
  Client-side regex serves as fail-fast guard only.

inputs:
  query:
    type: string
    required: true
    min_length: 2
    description: |
      Gene symbol to search (case-insensitive).
      Examples: "TP53", "BRCA1", "tp53" (normalized to "TP53")
    validation: |
      Fail-fast: Must match pattern ^[A-Za-z0-9][A-Za-z0-9\-_@.]{0,29}$
      Primary: Confirmed via BioGRID API (format=count)
    examples:
      - "TP53"
      - "BRCA1"
      - "HLA-A"

  slim:
    type: boolean
    required: false
    default: false
    description: |
      Token budgeting parameter (Constitution Principle IV).
      BioGridSearchCandidate is already minimal (~30 tokens);
      slim mode returns same fields for API consistency.

  organism:
    type: integer
    required: false
    default: 9606
    description: NCBI Taxonomy ID filter
    examples:
      - 9606  # Homo sapiens
      - 10090 # Mus musculus
      - 7227  # Drosophila melanogaster

api_call:
  endpoint: /interactions/
  method: GET
  parameters:
    geneList: "{symbol}"
    taxId: "{organism}"
    searchNames: "true"
    format: "count"
    accesskey: "{api_key}"
  response: |
    Single integer (text/plain). Example: "14523"
    count == 0 → ENTITY_NOT_FOUND
    count > 0 → BioGridSearchCandidate with interaction_count

output:
  envelope: PaginationEnvelope
  content_type: BioGridSearchCandidate
  description: Gene confirmed to exist in BioGRID with interaction count
  example:
    items:
      - symbol: "TP53"
        organism: "Homo sapiens"
        taxon_id: 9606
        interaction_count: 14523
    pagination:
      cursor: null
      total_count: 1
      page_size: 1

errors:
  AMBIGUOUS_QUERY:
    http_status: 400
    message: "Query must be at least 2 characters"
    recovery_hint: "Provide a more specific gene symbol (minimum 2 characters)"
    trigger: len(query) < 2 or invalid regex format
    example_invalid_input: "A"

  ENTITY_NOT_FOUND:
    http_status: 404
    message: "Gene not found in BioGRID: {symbol}"
    recovery_hint: "Verify gene symbol is correct. Use HGNC search_genes for official symbol resolution."
    trigger: BioGRID API returns count == 0
    example_invalid_input: "ZZZZZ99"

  UPSTREAM_ERROR:
    http_status: 502
    message: "BioGRID API error: {details}"
    recovery_hint: "Check BIOGRID_API_KEY is valid. Get free key at https://webservice.thebiogrid.org/"
    trigger: BioGRID API returns error (missing/invalid API key, 500, timeout)
    example_invalid_input: ""

  RATE_LIMITED:
    http_status: 429
    message: "Rate limit exceeded"
    recovery_hint: "Wait 1 second before retrying. Rate limit: 2 req/sec"
    trigger: Client-side rate limiting or HTTP 429 from BioGRID
    example_invalid_input: ""

examples:
  - name: Search human TP53 (confirmed in BioGRID)
    input:
      query: "TP53"
      organism: 9606
    output:
      items:
        - symbol: "TP53"
          organism: "Homo sapiens"
          taxon_id: 9606
          interaction_count: 14523
      pagination:
        cursor: null
        total_count: 1
        page_size: 1

  - name: Search with case normalization
    input:
      query: "tp53"
      organism: 9606
    output:
      items:
        - symbol: "TP53"
          organism: "Homo sapiens"
          taxon_id: 9606
          interaction_count: 14523
      pagination:
        cursor: null
        total_count: 1
        page_size: 1

  - name: Nonexistent gene
    input:
      query: "ZZZZZ99"
      organism: 9606
    output:
      error:
        code: "ENTITY_NOT_FOUND"
        message: "Gene not found in BioGRID: ZZZZZ99"
        recovery_hint: "Verify gene symbol is correct. Use HGNC search_genes for official symbol resolution."
        invalid_input: "ZZZZZ99"

usage_notes:
  - Gene symbols are case-insensitive; normalized to uppercase by client
  - Fail-fast regex guard prevents invalid API calls (alphanumeric + hyphens, 2+ chars)
  - Primary validation is BioGRID API with format=count (~200ms lightweight check)
  - searchNames=true enables synonym matching for broader coverage
  - Presence in results confirms gene exists in BioGRID; nonexistent genes get ENTITY_NOT_FOUND
  - Always search before calling get_interactions (Constitution Principle II)

adr_compliance:
  - "FULL Fuzzy-to-Fact: API-backed search confirms gene exists in BioGRID (Constitution Principle II)"
  - "PaginationEnvelope wrapper (ADR-001 §8)"
  - "ErrorEnvelope for all errors (ADR-001 §8)"
  - "ENTITY_NOT_FOUND for genes not in BioGRID (ADR-001 §9)"
  - "Client-side regex as fail-fast guard only (not primary validation)"
