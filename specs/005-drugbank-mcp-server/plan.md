# Implementation Plan: DrugBank MCP Server

**Branch**: `005-drugbank-mcp-server` | **Date**: 2025-12-22 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/005-drugbank-mcp-server/spec.md`

**Note**: This plan was generated by `/speckit.plan` following the SpecKit SDLC workflow.

## Summary

Build a FastMCP server that wraps the DrugBank public API to provide drug and drug target information for drug discovery research. The server implements the Fuzzy-to-Fact protocol with two tools: `search_drugs` (fuzzy search returning ranked candidates) and `get_drug` (strict lookup by DrugBank CURIE). All outputs use the Agentic Biolink schema with canonical envelopes and 22-key cross-reference mappings.

**Key Consideration**: DrugBank has tiered API access (public vs commercial). The public API provides basic drug information; commercial API requires API key for enhanced data access.

## Technical Context

**Language/Version**: Python 3.11+
**Primary Dependencies**: FastMCP, httpx (async HTTP client), pydantic
**Storage**: N/A (stateless architecture - live queries to DrugBank API)
**Testing**: pytest-asyncio (integration + unit tests)
**Target Platform**: Linux server (FastMCP runtime environment)
**Project Type**: Single (MCP server)
**Performance Goals**:
- <2s for 95% of search queries (SC-001)
- <1s for 100% of valid CURIE lookups (SC-002)
- >90% relevance accuracy for well-known drugs (SC-003)
- 100 concurrent requests without degradation (SC-004)

**Constraints**:
- DrugBank public API has limited data access (FR-005)
- Rate limiting: 10 req/s with exponential backoff (prevent API throttling)
- Token budgeting: Slim mode (~20 tokens) vs full mode (~115-300 tokens)
- Cross-reference accuracy: >95% for well-studied drugs (SC-006)
- DrugBank ID format: `^DrugBank:DB\d{5}$` (5-digit numeric suffix)

**Scale/Scope**:
- 2 MCP tools (search_drugs, get_drug)
- 50+ tests target (matching UniProt standard)
- 22-key cross-reference registry support
- 5 error codes with recovery hints

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Principle I: Async-First Architecture

**Status**: ✅ PASS

**Details**:
- ✅ DrugBankClient extends LifeSciencesClient (async base class)
- ✅ DrugBank uses REST API accessible via native `httpx` async client
- ✅ No synchronous SDK - native async throughout
- ✅ Connection pooling with max 10 concurrent connections

**Compliance**: PASS (no exception needed - unlike ChEMBL)

### Principle II: Fuzzy-to-Fact Resolution Protocol

**Status**: ✅ PASS

**Details**:
- ✅ Phase 1 (Fuzzy): `search_drugs(query)` accepts natural language, returns ranked DrugSearchCandidate results
- ✅ Phase 2 (Strict): `get_drug(drugbank_id)` accepts ONLY DrugBank CURIEs (`^DrugBank:DB\d{5}$`)
- ✅ Failure Mode: Invalid CURIE format returns UNRESOLVED_ENTITY with recovery hint

**Compliance**: PASS

### Principle III: Schema Determinism

**Status**: ✅ PASS

**Details**:
- ✅ Pagination Envelope: `search_drugs` returns `{items, pagination: {cursor, total_count, page_size}}`
- ✅ Error Envelope: All errors return `{success: false, error: {code, message, recovery_hint, invalid_input}}`
- ✅ Cross-References: Drug records include `cross_references` object using 22-key registry
- ✅ Omit-if-null: Cross-reference keys omitted entirely when no mapping exists (never null)
- ✅ Error Codes: UNRESOLVED_ENTITY, ENTITY_NOT_FOUND, AMBIGUOUS_QUERY, RATE_LIMITED, UPSTREAM_ERROR

**Compliance**: PASS

### Principle IV: Token Budgeting

**Status**: ✅ PASS

**Details**:
- ✅ slim=True parameter supported on all tools
- ✅ Slim mode: ~20 tokens/drug (id, name, drug_type, categories only)
- ✅ Full mode: ~115-300 tokens/drug (all fields + cross_references)
- ✅ Default page_size=50 (configurable 1-100)

**Compliance**: PASS

### Principle V: Specification-Before-Code

**Status**: ✅ PASS

**Details**:
- ✅ `/scaffold-fastmcp drugbank` completed (server structure)
- ✅ `/speckit.specify` completed (spec.md with 4 User Stories, 29 FRs, 7 SCs)
- ✅ `/speckit.plan` in progress (this document)
- ⏭️ `/speckit.tasks` pending (after plan approval)
- ⏭️ Implementation pending (after human gate approval)

**Compliance**: PASS

### Principle VI: Platform Skill Delegation

**Status**: ✅ PASS

**Details**:
- ✅ Used `/scaffold-fastmcp drugbank` to generate server structure
- ✅ Following SpecKit workflow (`/speckit.specify` → `/speckit.plan` → `/speckit.tasks` → `/speckit.implement`)
- ✅ Using standard prompt template from `docs/speckit-standard-prompt.md`

**Compliance**: PASS

### Overall Gate Decision

**Result**: ✅ **ALL PRINCIPLES PASS**

All 6 Constitution principles satisfied without exceptions. DrugBank REST API is natively async-compatible via httpx, eliminating the synchronous SDK complexity seen in ChEMBL. Proceeding to Phase 0 research.

## Project Structure

### Documentation (this feature)

```text
specs/005-drugbank-mcp-server/
├── spec.md              # Feature specification (complete)
├── plan.md              # This file (/speckit.plan output)
├── research.md          # Phase 0 output (API research)
├── data-model.md        # Phase 1 output (Drug, DrugSearchCandidate)
├── quickstart.md        # Phase 1 output (usage guide)
├── contracts/           # Phase 1 output (tool signatures)
│   ├── search_drugs.json
│   └── get_drug.json
├── checklists/
│   └── requirements.md  # Spec quality validation (complete)
└── tasks.md             # Phase 2 output (/speckit.tasks - NOT created yet)
```

### Source Code (repository root)

```text
# Single project structure (MCP server)
src/lifesciences_mcp/
├── servers/
│   ├── hgnc.py                    # Existing (21 tests)
│   ├── uniprot.py                 # Existing (29 tests)
│   ├── chembl.py                  # Tier 0 (pending implementation)
│   ├── opentargets.py             # Tier 0 (pending implementation)
│   └── drugbank.py                # THIS SERVER
├── client.py                       # DrugBankClient (extend LifeSciencesClient)
├── models/
│   ├── __init__.py
│   ├── envelopes.py               # PaginationEnvelope, ErrorEnvelope (existing)
│   ├── gene.py                    # Existing
│   ├── protein.py                 # Existing
│   └── drug.py                    # NEW: Drug, DrugSearchCandidate
└── __init__.py

tests/
├── integration/
│   └── test_drugbank_api.py       # Integration tests (scaffolded)
└── unit/
    └── test_drugbank_models.py    # Model validation tests (NEW)
```

**Structure Decision**: Single project extending existing life sciences MCP server architecture with new DrugBank client and models.

## Complexity Tracking

> No Constitution violations requiring justification. All principles pass without exception.

---

## Phase 0: Research & Technical Decisions

**Output**: [research.md](./research.md)

Research items to resolve before Phase 1 design:

| ID | Unknown | Research Task |
|----|---------|---------------|
| R1 | DrugBank API Structure | Explore DrugBank public API endpoints, authentication, response formats |
| R2 | Rate Limiting | Determine rate limits for public API access |
| R3 | DrugBank ID Validation | Confirm ID format pattern and validation regex |
| R4 | Cross-Reference Mapping | Map DrugBank external links to 22-key registry |
| R5 | Search Mechanism | Determine search endpoint availability and query syntax |
| R6 | Error Response Format | Map DrugBank API errors to our 6 error codes |
| R7 | Pagination Mechanism | Determine pagination approach (offset, cursor, etc.) |

---

## Phase 1: Design & Contracts

**Prerequisites**: research.md complete ✅

**Status**: ✅ **PHASE 1 COMPLETE** (2025-12-22)

### All Artifacts Generated

| Artifact | Status | Description |
|----------|--------|-------------|
| `plan.md` | ✅ Complete | This file - implementation plan with Constitution check |
| `research.md` | ✅ Complete | 7 research items resolved (R1-R7) |
| `data-model.md` | ✅ Complete | 2 Pydantic models: Drug, DrugSearchCandidate |
| `quickstart.md` | ✅ Complete | 4 workflow examples with error recovery |
| `contracts/search_drugs.json` | ✅ Complete | Fuzzy search tool contract |
| `contracts/get_drug.json` | ✅ Complete | Strict lookup tool contract |

### Validation Completed

- [x] All 2 contracts follow established pattern
- [x] Contracts aligned with data-model.md schemas
- [x] Error codes match research.md R6 definitions
- [x] Constitution compliance documented in each contract

---

## Next Steps

**Ready for**: `/speckit.tasks` to generate task breakdown
