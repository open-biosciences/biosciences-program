# Implementation Plan: ChEMBL MCP Server

**Branch**: `003-chembl-mcp-server` | **Date**: 2025-12-22 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-chembl-mcp-server/spec.md`

**Note**: This plan was generated by `/speckit.plan` following the SpecKit SDLC workflow.

## Summary

Build a FastMCP server that wraps the ChEMBL REST API and SDK to provide compound and bioactivity data for drug discovery research. The server implements the Fuzzy-to-Fact protocol with three tools: `search_compounds` (fuzzy search returning ranked candidates), `get_compound` (strict lookup by ChEMBL CURIE), and `get_compounds_batch` (batch operations to prevent thread pool exhaustion). All outputs use the Agentic Biolink schema with canonical envelopes and 22-key cross-reference mappings.

**Key Challenge**: ChEMBL uses a synchronous SDK (`chembl_webresource_client`) that must be wrapped with `asyncio.run_in_executor` per ADR-001 §2 exception to comply with async-first architecture.

## Technical Context

**Language/Version**: Python 3.11+
**Primary Dependencies**: FastMCP, httpx, chembl_webresource_client (synchronous SDK), pydantic
**Storage**: N/A (stateless architecture - live queries to ChEMBL REST API)
**Testing**: pytest-asyncio (integration + unit tests)
**Target Platform**: Linux server (FastMCP runtime environment)
**Project Type**: Single (MCP server)
**Performance Goals**:
- <2s for 95% of search queries (SC-001)
- <1s for 100% of valid CURIE lookups (SC-002)
- >90% relevance accuracy for well-known drugs (SC-003)
- 100 concurrent requests without degradation (SC-004)

**Constraints**:
- ChEMBL SDK is synchronous - MUST wrap with `run_in_executor` (ADR-001 §2 exception)
- Rate limiting: 10 req/s with exponential backoff (prevent API throttling)
- Token budgeting: Slim mode (~20 tokens) vs full mode (~115-300 tokens)
- Cross-reference accuracy: >95% for well-studied compounds (SC-006)

**Scale/Scope**:
- 3 MCP tools (search_compounds, get_compound, get_compounds_batch)
- 50+ tests target (matching UniProt standard)
- 22-key cross-reference registry support
- 6 error codes with recovery hints

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Principle I: Async-First Architecture

**Status**: ⚠️ EXCEPTION APPROVED

**Details**:
- ✅ ChEMBLClient extends LifeSciencesClient (async base class)
- ⚠️ chembl_webresource_client SDK is synchronous (PyPI package limitation)
- ✅ **Mitigation**: Wrap SDK calls with `asyncio.run_in_executor` per ADR-001 §2
- ✅ **Additional Mitigation**: Provide `get_compounds_batch` tool to prevent thread pool exhaustion during bulk operations

**Compliance**: PASS (with documented exception)

### Principle II: Fuzzy-to-Fact Resolution Protocol

**Status**: ✅ PASS

**Details**:
- ✅ Phase 1 (Fuzzy): `search_compounds(query)` accepts natural language, returns ranked CompoundSearchCandidate results
- ✅ Phase 2 (Strict): `get_compound(chembl_id)` accepts ONLY ChEMBL CURIEs (`^CHEMBL:[0-9]+$`)
- ✅ Phase 2 (Batch): `get_compounds_batch(chembl_ids)` for batch strict lookups
- ✅ Failure Mode: Invalid CURIE format returns UNRESOLVED_ENTITY with recovery hint

**Compliance**: PASS

### Principle III: Schema Determinism

**Status**: ✅ PASS

**Details**:
- ✅ Pagination Envelope: `search_compounds` returns `{items, pagination: {cursor, total_count, page_size}}`
- ✅ Error Envelope: All errors return `{success: false, error: {code, message, recovery_hint, invalid_input}}`
- ✅ Cross-References: Compound records include `cross_references` object using 22-key registry
- ✅ Omit-if-null: Cross-reference keys omitted entirely when no mapping exists (never null)
- ✅ Error Codes: UNRESOLVED_ENTITY, ENTITY_NOT_FOUND, AMBIGUOUS_QUERY, RATE_LIMITED, UPSTREAM_ERROR, INVALID_CROSS_REFERENCE

**Compliance**: PASS

### Principle IV: Token Budgeting

**Status**: ✅ PASS

**Details**:
- ✅ slim=True parameter supported on all tools
- ✅ Slim mode: ~20 tokens/compound (id, name, molecular_formula only)
- ✅ Full mode: ~115-300 tokens/compound (all fields + cross_references)
- ✅ Default page_size=50 (configurable 1-100)
- ✅ Batch operations default to slim=True

**Compliance**: PASS

### Principle V: Specification-Before-Code

**Status**: ✅ PASS

**Details**:
- ✅ `/speckit.specify` completed (spec.md with 4 User Stories, 31 FRs, 7 SCs)
- ✅ `/speckit.plan` in progress (this document)
- ⏭️ `/speckit.tasks` pending (after plan approval)
- ⏭️ Implementation pending (after human gate approval)

**Compliance**: PASS

### Principle VI: Platform Skill Delegation

**Status**: ✅ PASS

**Details**:
- ✅ Used `/scaffold-fastmcp chembl` to generate server structure
- ✅ Following SpecKit workflow (`/speckit.specify` → `/speckit.plan` → `/speckit.tasks` → `/speckit.implement`)
- ✅ Using standard prompt template from `docs/speckit-standard-prompt.md`

**Compliance**: PASS

### Overall Gate Decision

**Result**: ✅ **PASS WITH DOCUMENTED EXCEPTION**

All principles satisfied. Principle I (Async-First) exception documented and mitigated per ADR-001 §2. Proceeding to Phase 0 research.

## Project Structure

### Documentation (this feature)

```text
specs/003-chembl-mcp-server/
├── spec.md              # Feature specification (complete)
├── plan.md              # This file (/speckit.plan output)
├── research.md          # Phase 0 output (API research, SDK analysis)
├── data-model.md        # Phase 1 output (Compound, CompoundSearchCandidate)
├── quickstart.md        # Phase 1 output (usage guide)
├── contracts/           # Phase 1 output (tool signatures)
│   ├── search_compounds.json
│   ├── get_compound.json
│   └── get_compounds_batch.json
├── checklists/
│   └── requirements.md  # Spec quality validation (complete)
└── tasks.md             # Phase 2 output (/speckit.tasks - NOT created yet)
```

### Source Code (repository root)

```text
# Single project structure (MCP server)
src/lifesciences_mcp/
├── servers/
│   ├── hgnc.py                    # Existing (21 tests)
│   ├── uniprot.py                 # Existing (29 tests)
│   └── chembl.py                  # THIS FEATURE (scaffolded, needs implementation)
├── clients/                        # Phase 0 namespace refactor (ADR-005)
│   ├── base.py                    # LifeSciencesClient base class
│   ├── hgnc.py                    # Migrated from client.py
│   ├── uniprot.py                 # Migrated from client.py
│   └── chembl.py                  # THIS FEATURE (extends base, wraps SDK)
├── models/
│   ├── __init__.py
│   ├── envelopes.py               # Existing (PaginationEnvelope, ErrorEnvelope)
│   ├── gene.py                    # Existing (HGNC models)
│   ├── protein.py                 # Existing (UniProt models)
│   └── compound.py                # THIS FEATURE (Compound, CompoundSearchCandidate)
└── __init__.py                    # Update exports

tests/
├── integration/
│   ├── test_hgnc_api.py           # Existing
│   ├── test_uniprot_api.py        # Existing
│   ├── test_chembl_api.py         # THIS FEATURE (scaffolded, needs implementation)
│   └── test_performance.py        # THIS FEATURE (SC-001 validation)
└── unit/
    ├── test_envelopes.py          # Existing
    ├── test_chembl_models.py      # THIS FEATURE (Compound validation)
    └── test_chembl_client.py      # THIS FEATURE (SDK wrapping, error handling)
```

**Structure Decision**: Single project structure maintained. All MCP servers follow the same pattern established by HGNC and UniProt. ChEMBL adds new models (`compound.py`) and client (`clients/chembl.py`) following the namespace refactor from ADR-005.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| Principle I: Synchronous SDK | ChEMBL Python client (`chembl_webresource_client`) is the official SDK, maintained by EMBL-EBI. Direct REST API calls would require reimplementing complex query logic. | Using `httpx` directly would require reverse-engineering the SDK's search algorithms, pagination logic, and data transformations. The SDK is battle-tested and handles API versioning. |
| Thread pool wrapping | Synchronous SDK calls MUST be wrapped in `run_in_executor` to prevent event loop blocking | ADR-001 §2 explicitly permits this exception for legacy SDKs. Alternative (pure REST implementation) rejected above. |
| Batch tool required | `get_compounds_batch` adds complexity (3 tools instead of 2) | Without batch tool, agents performing bulk lookups (e.g., "get compounds for these 50 targets") would exhaust the thread pool by spawning 50 concurrent `run_in_executor` calls. Batch tool amortizes the thread pool cost. |

**Justification**: These complexities are unavoidable given ChEMBL's SDK architecture. ADR-001 §2 explicitly acknowledges this trade-off and provides the exception. The batch tool is a necessary safety valve for the thread pool limitation.
